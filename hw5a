import streamlit as st
import pdfplumber
import pytesseract
from PIL import Image
from pptx import Presentation
from transformers import pipeline
import tempfile
import os

# =========================
# Page Config
# =========================
st.set_page_config(
    page_title="AI Text & Slide Detection Demo",
    layout="wide"
)

st.title("ğŸ“„ AI æ–‡å­— / ç°¡å ± AI ç”Ÿæˆåµæ¸¬ Demo")

# =========================
# Load AI Detector
# =========================
@st.cache_resource
def load_ai_detector():
    return pipeline(
        "text-classification",
        model="roberta-base-openai-detector"
    )

ai_detector = load_ai_detector()

# =========================
# Utils
# =========================
def detect_ai(text):
    if len(text.strip()) < 30:
        return "âš ï¸ æ–‡å­—å¤ªçŸ­ï¼Œç„¡æ³•åˆ¤æ–·"

    result = ai_detector(text[:1000])[0]
    return f"{result['label']}ï¼ˆä¿¡å¿ƒ {result['score']:.2f}ï¼‰"

# =========================
# PDF Text
# =========================
def extract_pdf_text(file):
    text = ""
    with pdfplumber.open(file) as pdf:
        for page in pdf.pages:
            t = page.extract_text()
            if t:
                text += t + "\n"
    return text

# =========================
# PPT Text
# =========================
def extract_ppt_text(file):
    prs = Presentation(file)
    text = ""
    for slide in prs.slides:
        for shape in slide.shapes:
            if hasattr(shape, "text"):
                text += shape.text + "\n"
    return text

# =========================
# Image OCR (No PaddleOCR)
# =========================
def extract_image_text(file):
    image = Image.open(file)
    return pytesseract.image_to_string(image, lang="eng")

# =========================
# UI Tabs
# =========================
tab1, tab2, tab3 = st.tabs(["ğŸ“„ PDF", "ğŸ–¼ åœ–ç‰‡ OCR", "ğŸ“Š PPT"])

# -------- PDF --------
with tab1:
    st.subheader("PDF æ–‡å­—æ“·å–èˆ‡ AI åµæ¸¬")
    pdf_file = st.file_uploader("ä¸Šå‚³ PDF", type=["pdf"])

    if pdf_file:
        text = extract_pdf_text(pdf_file)
        st.text_area("æ“·å–æ–‡å­—", text, height=300)
        st.success(detect_ai(text))

# -------- Image --------
with tab2:
    st.subheader("åœ–ç‰‡ OCR èˆ‡ AI åµæ¸¬ï¼ˆä¸ä½¿ç”¨ PaddleOCRï¼‰")
    img_file = st.file_uploader("ä¸Šå‚³åœ–ç‰‡", type=["png", "jpg", "jpeg"])

    if img_file:
        st.image(img_file, width=300)
        text = extract_image_text(img_file)
        st.text_area("OCR æ–‡å­—", text, height=300)
        st.success(detect_ai(text))

# -------- PPT --------
with tab3:
    st.subheader("PPT ç°¡å ±æ–‡å­—æ“·å–èˆ‡ AI åµæ¸¬")
    ppt_file = st.file_uploader("ä¸Šå‚³ PPT", type=["pptx"])

    if ppt_file:
        text = extract_ppt_text(ppt_file)
        st.text_area("æ“·å–æ–‡å­—", text, height=300)
        st.success(detect_ai(text))

# =========================
st.caption("âœ… ä¸ä½¿ç”¨ PaddleOCR / OpenCVï¼ŒStreamlit Cloud å®Œå…¨æ”¯æ´")

